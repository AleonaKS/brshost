
{% extends "base.html" %}
{% block title %}{{title}}{% endblock %}
{% block content %}
<h1>Ð—Ð°ÐºÐ»Ð°Ð´ÐºÐ¸</h1>
{% if books %}
<div class="book-grid">
    {% for book in books %}
    <div class="book-card">
        <a href="{% url 'book_detail' book_id=book.id %}">
            <img src="{{ book.image_link }}" alt="{{ book.title }}">
        </a>
      <div class="title">{{ book.title }}</div>
      <div class="author">
        {% for author in book.author.all %}
          {{ author.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </div>
       
    <div class="actions">
        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð’ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ" -->
        <button 
            class="add-to-cart-btn" 
            data-book-id="{{ book.id }}"
            type="button"
            >
            ðŸ›’ Ð’ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
        </button>

        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð’ Ð·Ð°ÐºÐ»Ð°Ð´ÐºÐ¸" -->
        <button 
            class="add-to-bookmarks-btn" 
            data-book-id="{{ book.id }}"
            type="button"
            >
            ðŸ”– Ð’ Ð·Ð°ÐºÐ»Ð°Ð´ÐºÐ¸
        </button>
    </div>
    </div>
    {% empty %}
    <p>ÐšÐ½Ð¸Ð³Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹.</p>
{% endfor %}
  </div>
{% endif %}

 
</div>
<script>

document.addEventListener('DOMContentLoaded', () => {
    const csrftoken = '{{ csrf_token }}';

    function postData(url = '', data = {}) {
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(data),
            credentials: 'include',
        })
        .then(response => {
            if (!response.ok) throw new Error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸');
            return response.json();
        });
    }

    // Ð”Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ð¸ 
    const cartState = new Map();
    const bookmarksState = new Map();

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
    function updateCartBtn(button, inCart) {
        if (inCart) {
            button.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹';
            button.classList.add('active');
        } else {
            button.textContent = 'ðŸ›’ Ð’ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ';
            button.classList.remove('active');
        }
    }

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð·Ð°ÐºÐ»Ð°Ð´Ð¾Ðº
    function updateBookmarksBtn(button, inBookmarks) {
        if (inBookmarks) {
            button.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð· Ð·Ð°ÐºÐ»Ð°Ð´Ð¾Ðº';
            button.classList.add('active');
        } else {
            button.textContent = 'ðŸ”– Ð’ Ð·Ð°ÐºÐ»Ð°Ð´ÐºÐ¸';
            button.classList.remove('active');
        }
    }

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿Ð¾Ðº ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        const bookId = button.dataset.bookId;

        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ false)
        cartState.set(bookId, false);
        updateCartBtn(button, false);

        button.addEventListener('click', () => {
            const inCart = cartState.get(bookId);
            if (!inCart) {
                postData('/api/cart/add/', { book_id: bookId })
                    .then(() => {
                        cartState.set(bookId, true);
                        updateCartBtn(button, true);
                        alert('ÐšÐ½Ð¸Ð³Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ');
                    })
                    .catch(() => alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ'));
            } else {
                postData('/api/cart/remove/', { book_id: bookId })
                    .then(() => {
                        cartState.set(bookId, false);
                        updateCartBtn(button, false);
                        alert('ÐšÐ½Ð¸Ð³Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹');
                    })
                    .catch(() => alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹'));
            }
        });
    });

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð·Ð°ÐºÐ»Ð°Ð´Ð¾Ðº
    document.querySelectorAll('.add-to-bookmarks-btn').forEach(button => {
        const bookId = button.dataset.bookId;

        bookmarksState.set(bookId, false);
        updateBookmarksBtn(button, false);

        button.addEventListener('click', () => {
            const inBookmarks = bookmarksState.get(bookId);
            if (!inBookmarks) {
                postData('/api/bookmarks/add/', { book_id: bookId })
                    .then(() => {
                        bookmarksState.set(bookId, true);
                        updateBookmarksBtn(button, true);
                        alert('ÐšÐ½Ð¸Ð³Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð² Ð·Ð°ÐºÐ»Ð°Ð´ÐºÐ¸');
                    })
                    .catch(() => alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð² Ð·Ð°ÐºÐ»Ð°Ð´ÐºÐ¸'));
            } else {
                postData('/api/bookmarks/remove/', { book_id: bookId })
                    .then(() => {
                        bookmarksState.set(bookId, false);
                        updateBookmarksBtn(button, false);
                        alert('ÐšÐ½Ð¸Ð³Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð¸Ð· Ð·Ð°ÐºÐ»Ð°Ð´Ð¾Ðº');
                    })
                    .catch(() => alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¸Ð· Ð·Ð°ÐºÐ»Ð°Ð´Ð¾Ðº'));
            }
        });
    });
});

</script>


{% endblock %}
